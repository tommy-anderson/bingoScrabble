# Architecture

## System Overview

Scrabble Bingo is a real-time multiplayer web application that allows 4 friends playing Scrabble to have a side bingo game with challenges. The architecture prioritizes:

- **Real-time synchronization** - All players see updates instantly
- **Mobile-first design** - Optimized for phone browsers during Scrabble games
- **Session persistence** - Players can rejoin after accidental disconnects
- **Serverless deployment** - Free hosting on Vercel + Convex

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT (Next.js 15)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  Home Page  │  │  Game Page  │  │     localStorage        │  │
│  │  - Create   │  │  - Lobby    │  │  - sessionId            │  │
│  │  - Join     │  │  - Board    │  │  - playerId             │  │
│  └──────┬──────┘  └──────┬──────┘  │  - gameCode             │  │
│         │                │         └─────────────────────────┘  │
└─────────┼────────────────┼──────────────────────────────────────┘
          │                │
          │  Real-time     │  Real-time
          │  Mutations     │  Queries + Subscriptions
          │                │
┌─────────┴────────────────┴──────────────────────────────────────┐
│                      CONVEX BACKEND                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      Functions                           │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐    │    │
│  │  │   games.ts  │ │ players.ts  │ │    boards.ts    │    │    │
│  │  │ - create    │ │ - join      │ │ - generate      │    │    │
│  │  │ - start     │ │ - reconnect │ │ - markSquare    │    │    │
│  │  │ - getByCode │ │ - getAll    │ │ - checkWin      │    │    │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      Database                            │    │
│  │  ┌─────────┐    ┌──────────┐    ┌─────────┐             │    │
│  │  │  games  │───▶│  players │───▶│  boards │             │    │
│  │  └─────────┘    └──────────┘    └─────────┘             │    │
│  └─────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
```

## Data Models

### Games Table

```typescript
{
  _id: Id<"games">,           // Auto-generated by Convex
  code: string,               // 6-character uppercase code (e.g., "ABC123")
  hostPlayerId: Id<"players">,// Reference to host player
  status: "lobby" | "playing" | "finished",
  winnerId?: Id<"players">,   // Set when someone wins
  createdAt: number           // Unix timestamp
}
```

### Players Table

```typescript
{
  _id: Id<"players">,         // Auto-generated by Convex
  gameId: Id<"games">,        // Reference to game
  name: string,               // Player display name
  sessionId: string,          // UUID for reconnection
  isHost: boolean,            // True for game creator
  joinedAt: number            // Unix timestamp
}
```

### Boards Table

```typescript
{
  _id: Id<"boards">,          // Auto-generated by Convex
  playerId: Id<"players">,    // Reference to player
  gameId: Id<"games">,        // Reference to game
  squares: Array<{            // 25 squares (5x5 grid)
    challenge: string,        // Challenge text
    marked: boolean           // Whether player completed it
  }>
}
```

## Real-time Data Flow

### Creating a Game
1. User clicks "Create Game" and enters name
2. Client generates a unique `sessionId` (UUID)
3. Mutation `createGame` creates game + host player records
4. Client stores `sessionId`, `playerId`, `gameCode` in localStorage
5. Client redirects to `/game/[code]`

### Joining a Game
1. User enters game code and name
2. Client generates a unique `sessionId` (UUID)
3. Mutation `joinGame` creates player record linked to game
4. Client stores session data in localStorage
5. Real-time subscription updates all clients with new player

### Starting the Game
1. Host clicks "Start Game" (only visible when 4 players joined)
2. Mutation `startGame`:
   - Updates game status to "playing"
   - Generates 4 unique boards with challenges
   - Creates board records for each player
3. All clients receive real-time update, transition to board view

### Marking a Square
1. Player taps a square on their board
2. Mutation `markSquare` toggles the square's `marked` status
3. Win detection runs server-side
4. If win detected, game status updates to "finished"
5. All clients receive updates in real-time

## Session Persistence Strategy

```
┌──────────────────────────────────────────────────────────────┐
│                    Session Recovery Flow                      │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  1. User opens /game/ABC123                                   │
│                    │                                          │
│                    ▼                                          │
│  2. Check localStorage for matching gameCode                  │
│                    │                                          │
│         ┌─────────┴─────────┐                                │
│         │                   │                                 │
│         ▼                   ▼                                 │
│    Has Session         No Session                             │
│         │                   │                                 │
│         ▼                   ▼                                 │
│  3a. Query Convex      3b. Show Join Form                     │
│      by sessionId           │                                 │
│         │                   ▼                                 │
│         ▼              4b. Create new player                  │
│  4a. Player found?          │                                 │
│         │                   ▼                                 │
│    ┌────┴────┐         5b. Store session                      │
│    │         │              │                                 │
│    ▼         ▼              │                                 │
│   Yes        No             │                                 │
│    │         │              │                                 │
│    ▼         ▼              │                                 │
│  Resume   Clear & ──────────┘                                 │
│  Game     Show Form                                           │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### localStorage Schema

```typescript
interface StoredSession {
  sessionId: string;    // UUID v4
  playerId: string;     // Convex document ID
  gameCode: string;     // 6-character game code
  playerName: string;   // For display while reconnecting
}
```

## Technology Choices

### Why Next.js 15?
- Native Vercel integration for free deployment
- App Router for modern React patterns
- Server components where beneficial
- Excellent TypeScript support

### Why Convex?
- Built-in real-time subscriptions (no WebSocket setup)
- Automatic TypeScript types from schema
- Generous free tier (enough for hobby projects)
- Zero configuration required
- Handles all the complex sync logic

### Why shadcn/ui?
- High-quality, accessible components
- Tailwind-based (easy customization)
- Copy-paste ownership (no dependency lock-in)
- Great mobile touch interactions

## Deployment Architecture

```
┌─────────────────┐     ┌─────────────────┐
│     Vercel      │     │     Convex      │
│  (Next.js App)  │◀───▶│   (Backend)     │
│                 │     │                 │
│  - Static pages │     │  - Database     │
│  - API routes   │     │  - Real-time    │
│  - Edge runtime │     │  - Functions    │
└─────────────────┘     └─────────────────┘
        │
        │ HTTPS
        ▼
   ┌─────────┐
   │  Users  │
   │(Mobile) │
   └─────────┘
```

Both services have generous free tiers:
- **Vercel**: Unlimited static sites, 100GB bandwidth/month
- **Convex**: 1M function calls/month, 1GB storage
